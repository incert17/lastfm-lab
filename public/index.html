<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Last.fm Wrapped</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;600;700&family=DM+Sans:wght@400;500;600&display=swap"
    rel="stylesheet"
  /> <!-- [web:476][web:483] -->

  <!-- Lottie web player -->
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script> <!-- [web:490] -->

  <style>
    :root {
      --fg-main: #f9fafb;
      --fg-soft: #e5e7eb;
      --fg-muted: #9ca3af;
      --accent-a: #ff2c7d;
      --accent-b: #36e3ff;
      --accent-c: #ffd33b;
      --bg-page: #020617;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body { height: 100%; }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #0f172a, #020617 65%);
      color: var(--fg-main);
      font-family: "DM Sans", system-ui, -apple-system, BlinkMacSystemFont,
        "SF Pro Text", "Inter", "Segoe UI", sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
    }

    /* ---------- layout shells ---------- */

    .root-shell {
      width: min(480px, 100vw);
      height: min(900px, 100vh);
      border-radius: 32px;
      overflow: hidden;
      background: #000;
      box-shadow:
        0 32px 80px rgba(0,0,0,0.9),
        0 0 0 1px rgba(148,163,184,0.4);
      position: relative;
    }

    .screen {
      position: absolute;
      inset: 0;
      display: none;
    }

    .screen.active {
      display: block;
    }

    /* ---------- input screen ---------- */

    #screen-input {
      background: radial-gradient(circle at top, #111827, #020617 65%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 32px 22px;
      text-align: center;
    }

    .logo-mark {
      font-family: "Space Grotesk", system-ui, sans-serif;
      font-size: 0.9rem;
      letter-spacing: 0.26em;
      text-transform: uppercase;
      color: var(--fg-soft);
      margin-bottom: 18px;
    }

    .input-title {
      font-family: "Space Grotesk", system-ui, sans-serif;
      font-size: 1.9rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      margin-bottom: 10px;
    }

    .input-sub {
      font-size: 0.9rem;
      color: var(--fg-muted);
      max-width: 320px;
      margin: 0 auto 24px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
      max-width: 320px;
      margin-bottom: 18px;
    }

    .input-label {
      text-align: left;
      font-size: 0.8rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--fg-soft);
    }

    #username {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.95);
      padding: 8px 14px;
      font-size: 0.9rem;
      color: var(--fg-main);
      outline: none;
      transition: border-color 160ms ease, box-shadow 160ms ease, transform 120ms ease;
    }

    #username::placeholder {
      color: rgba(148,163,184,0.9);
    }

    #username:focus {
      border-color: var(--accent-a);
      box-shadow: 0 0 0 1px rgba(248,113,113,0.4);
      transform: translateY(-1px);
    }

    .period-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .chip {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.8rem;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.95);
      color: var(--fg-soft);
      cursor: pointer;
      transition: border-color 150ms ease, background 150ms ease, color 150ms ease,
        transform 100ms ease;
    }

    .chip:hover {
      transform: translateY(-1px);
      border-color: rgba(248,250,252,0.9);
    }

    .chip.active {
      border-color: var(--accent-b);
      background: radial-gradient(circle at top, rgba(54,227,255,0.4), rgba(15,23,42,0.98));
      color: var(--fg-main);
    }

    #start-btn {
      margin-top: 20px;
      padding: 8px 20px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(90deg, var(--accent-a), var(--accent-b));
      color: #020617;
      font-size: 0.9rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      cursor: pointer;
      box-shadow: 0 16px 35px rgba(15,23,42,0.9);
      transition: transform 120ms ease, box-shadow 120ms ease, filter 120ms ease;
    }

    #start-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.9);
      filter: brightness(1.05);
    }

    #input-error {
      margin-top: 10px;
      font-size: 0.8rem;
      color: #fecaca;
      min-height: 1em;
    }

    /* ---------- story shell ---------- */

    #screen-story {
      background: #000;
      position: relative;
      overflow: hidden;
    }

    .card {
      position: absolute;
      inset: 0;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transform: translateY(24px) scale(0.96);
      transition: opacity 260ms ease-out, transform 260ms ease-out;
    }

    .card.active {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0) scale(1);
    }

    .card-lottie {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }

    .card-foreground {
      position: relative;
      z-index: 1;
      text-align: center;
      padding: 32px 26px;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .cf-kicker {
      font-family: "Space Grotesk", system-ui, sans-serif;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--fg-soft);
      margin-bottom: 14px;
    }

    .cf-title {
      font-family: "Space Grotesk", system-ui, sans-serif;
      font-size: 1.9rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      max-width: 18ch;
      margin-bottom: 10px;
    }

    .cf-sub {
      font-size: 0.9rem;
      color: var(--fg-muted);
      max-width: 28ch;
    }

    .cf-stat {
      font-family: "Space Grotesk", system-ui, sans-serif;
      font-weight: 600;
      font-size: 3.2rem;
      letter-spacing: 0.06em;
      margin: 10px 0 6px;
    }

    .cf-caption {
      font-size: 0.9rem;
      color: var(--fg-soft);
      max-width: 26ch;
    }

    .cf-username {
      margin-top: 6px;
      font-size: 0.9rem;
      color: var(--fg-muted);
    }

    /* top track cover */
    .cf-art {
      width: 190px;
      height: 190px;
      border-radius: 24px;
      overflow: hidden;
      position: relative;
      box-shadow: 0 18px 40px rgba(0,0,0,0.85);
      margin: 6px auto 10px;
    }

    .cf-art::before {
      content: "";
      position: absolute;
      inset: -18%;
      background: conic-gradient(
        from 200deg,
        rgba(255,44,125,0.6),
        rgba(54,227,255,0.0),
        rgba(54,227,255,0.5),
        rgba(255,44,125,0.0),
        rgba(255,211,59,0.7)
      );
      mix-blend-mode: screen;
      filter: blur(14px);
    }

    .cf-art img {
      position: relative;
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: inherit;
      z-index: 1;
    }

    .cf-track-title {
      font-size: 1.2rem;
      letter-spacing: 0.03em;
      margin-top: 4px;
    }

    .cf-track-artist {
      margin-top: 2px;
      font-size: 0.9rem;
      color: var(--fg-soft);
    }

    /* genres stack */
    #genre-stack {
      width: 100%;
      max-width: 280px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
    }

    .genre-chip {
      position: relative;
      height: 40px;
      border-radius: 999px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #020617;
      box-shadow: 0 14px 35px rgba(0,0,0,0.7);
      transform: translateY(12px) scale(0.96);
      opacity: 0;
      transition: opacity 320ms ease-out, transform 320ms ease-out;
    }

    .genre-chip.ready {
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    .genre-chip::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, var(--accent-a), var(--accent-b));
      z-index: -1;
    }

    .genre-chip span {
      position: relative;
      z-index: 1;
    }

    /* story footer actions */
    .story-footer {
      position: absolute;
      inset-inline: 0;
      bottom: 14px;
      display: flex;
      justify-content: space-between;
      padding: 0 18px;
      font-size: 0.78rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--fg-soft);
      z-index: 2;
    }

    .story-link {
      cursor: pointer;
      opacity: 0.85;
    }

    .story-link:hover {
      opacity: 1;
    }

    .hidden { display: none; }
  </style>
</head>

<body>
  <div class="root-shell">
    <!-- INPUT SCREEN -->
    <section class="screen active" id="screen-input">
      <div class="logo-mark">last.fm wrapped</div>
      <div class="input-title">tune your recap</div>
      <p class="input-sub">enter a last.fm username and a time window to generate a wrapped‑style story.</p>

      <div class="input-group">
        <label class="input-label" for="username">username</label>
        <input id="username" type="text" placeholder="e.g. mylastfmuser" autocomplete="off" />
      </div>

      <div class="input-group">
        <div class="input-label">period</div>
        <div class="period-row" id="period-row">
          <button class="chip active" data-period="7day">7 days</button>
          <button class="chip" data-period="1month">1 month</button>
          <button class="chip" data-period="3month">3 months</button>
          <button class="chip" data-period="6month">6 months</button>
          <button class="chip" data-period="12month">1 year</button>
          <button class="chip" data-period="overall">overall</button>
        </div>
      </div>

      <button id="start-btn">see my wrapped</button>
      <div id="input-error"></div>
    </section>

    <!-- STORY SCREEN (LOADING + CARDS) -->
    <section class="screen" id="screen-story">
      <!-- Card 0: loading -->
      <section class="card active" id="card-loading">
        <lottie-player
          class="card-lottie"
          src="https://lottie.host/7a70c3c6-3a6c-46de-bd2a-ccf5ca3b0f5d/4fAVW5.json"
          background="transparent"
          speed="1"
          loop
          autoplay>
        </lottie-player>
        <div class="card-foreground">
          <div class="cf-kicker">hold on</div>
          <div class="cf-title">we're tuning your year</div>
          <p class="cf-sub">fetching your scrobbles and shaping them into something shareable.</p>
        </div>
      </section>

      <!-- Card 1: greeting -->
      <section class="card" id="card-hello">
        <lottie-player
          class="card-lottie"
          src="https://lottie.host/7a70c3c6-3a6c-46de-bd2a-ccf5ca3b0f5d/4fAVW5.json"
          background="transparent"
          speed="0.8"
          loop
          autoplay>
        </lottie-player>
        <div class="card-foreground">
          <div class="cf-kicker">hey there</div>
          <div class="cf-title" id="hello-title-card">@user</div>
          <p class="cf-sub" id="hello-sub-card">here's your time on last.fm.</p>
        </div>
      </section>

      <!-- Card 2: total scrobbles -->
      <section class="card" id="card-total">
        <lottie-player
          class="card-lottie"
          src="https://lottie.host/1a3f5de9-1d17-4731-bc39-86a9a068e20d/e9O4QF.json"
          background="transparent"
          speed="1"
          loop
          autoplay>
        </lottie-player>
        <div class="card-foreground">
          <div class="cf-kicker">you pressed play</div>
          <div class="cf-stat" id="total-value-card">0</div>
          <div class="cf-caption" id="total-caption-card">tracks scrobbled.</div>
        </div>
      </section>

      <!-- Card 3: top track -->
      <section class="card" id="card-track">
        <lottie-player
          class="card-lottie"
          src="https://lottie.host/69e8cefb-7a9d-4a6a-8f18-5397fce55c30/q0pgtQ.json"
          background="transparent"
          speed="1"
          loop
          autoplay>
        </lottie-player>
        <div class="card-foreground">
          <div class="cf-kicker">one song ruled them all</div>
          <div class="cf-art">
            <img id="toptrack-art" alt="">
          </div>
          <div class="cf-track-title" id="toptrack-title-card">track name</div>
          <div class="cf-track-artist" id="toptrack-artist-card">artist</div>
        </div>
      </section>

      <!-- Card 4: genres -->
      <section class="card" id="card-genres">
        <lottie-player
          class="card-lottie"
          src="https://lottie.host/8c706a69-ecdd-4a3c-89e4-4a29db6ad9c3/hJzlzM.json"
          background="transparent"
          speed="1"
          loop
          autoplay>
        </lottie-player>
        <div class="card-foreground">
          <div class="cf-kicker">the sounds around you</div>
          <p class="cf-sub">your top genres stacked up like this:</p>
          <div id="genre-stack"></div>
        </div>
      </section>

      <!-- Card 5: recap -->
      <section class="card" id="card-final">
        <lottie-player
          class="card-lottie"
          src="https://lottie.host/7a70c3c6-3a6c-46de-bd2a-ccf5ca3b0f5d/4fAVW5.json"
          background="transparent"
          speed="0.8"
          loop
          autoplay>
        </lottie-player>
        <div class="card-foreground">
          <div class="cf-kicker">that was your</div>
          <div class="cf-title" id="final-period-card">last few months</div>
          <p class="cf-sub" id="final-username-card">@user on last.fm</p>
        </div>
        <div class="story-footer">
          <span class="story-link" id="change-user-link">change user</span>
          <span class="story-link" id="replay-link">replay</span>
        </div>
      </section>
    </section>
  </div>

  <script>
    const DEFAULT_USERNAME = ""; // optional default

    const sceneInput = document.getElementById("screen-input");
    const sceneStory = document.getElementById("screen-story");

    const periodRow = document.getElementById("period-row");
    const usernameInput = document.getElementById("username");
    const startBtn = document.getElementById("start-btn");
    const inputError = document.getElementById("input-error");

    const storyCards = [
      "card-loading",
      "card-hello",
      "card-total",
      "card-track",
      "card-genres",
      "card-final"
    ];
    let currentCardIndex = 0;

    let currentUsername = "";
    let currentPeriod = "7day";
    let wrappedData = null;
    let genresData = null;

    function showScreen(which) {
      sceneInput.classList.toggle("active", which === "input");
      sceneStory.classList.toggle("active", which === "story");
    }

    function setActiveCard(id) {
      storyCards.forEach(cid => {
        const el = document.getElementById(cid);
        if (!el) return;
        el.classList.toggle("active", cid === id);
      });
      currentCardIndex = storyCards.indexOf(id);
    }

    function nextCard() {
      if (currentCardIndex >= storyCards.length - 1) return;
      const nextId = storyCards[currentCardIndex + 1];
      setActiveCard(nextId);
    }

    // period chips
    periodRow.addEventListener("click", (e) => {
      const chip = e.target.closest(".chip");
      if (!chip) return;
      periodRow.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
      chip.classList.add("active");
      currentPeriod = chip.dataset.period || "7day";
    });

    // tap to advance cards (except final)
    sceneStory.addEventListener("click", (e) => {
      const card = e.target.closest(".card");
      if (!card) return;
      if (card.id === "card-final") return;
      nextCard();
    });

    document.getElementById("replay-link").addEventListener("click", (e) => {
      e.stopPropagation();
      if (!wrappedData) return;
      setActiveCard("card-hello");
    });

    document.getElementById("change-user-link").addEventListener("click", (e) => {
      e.stopPropagation();
      showScreen("input");
    });

    function countUp(element, target, duration = 800) {
      const start = 0;
      const startTime = performance.now();
      function tick(now) {
        const elapsed = now - startTime;
        const t = Math.min(1, elapsed / duration);
        const value = Math.round(start + (target - start) * t);
        element.textContent = value.toLocaleString();
        if (t < 1) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    }

    function applyWrappedToCards(data) {
      const user = data.username || currentUsername;
      const periodLabel = data.periodLabel || "";

      document.getElementById("hello-title-card").textContent = `@${user}`;
      document.getElementById("hello-sub-card").textContent =
        periodLabel ? `here's your ${periodLabel} on last.fm.` : "here's your time on last.fm.";

      const total = Number(data.totalScrobbles) || 0;
      const totalEl = document.getElementById("total-value-card");
      totalEl.textContent = "0";
      countUp(totalEl, total);

      document.getElementById("total-caption-card").textContent =
        periodLabel ? `tracks scrobbled in ${periodLabel}.` : "tracks scrobbled.";

      const topTrack = (data.topTracks || [])[0];
      if (topTrack) {
        const img = document.getElementById("toptrack-art");
        img.src = topTrack.image || "";
        img.alt = `${topTrack.name || "Track"} – ${topTrack.artist || ""}`;
        document.getElementById("toptrack-title-card").textContent = topTrack.name || "Unknown track";
        document.getElementById("toptrack-artist-card").textContent = topTrack.artist || "";
      }

      document.getElementById("final-period-card").textContent =
        periodLabel || "your time";
      document.getElementById("final-username-card").textContent =
        `@${user} on last.fm`;
    }

    function applyGenres(genres) {
      const container = document.getElementById("genre-stack");
      container.innerHTML = "";
      if (!genres || !Array.isArray(genres.topGenres)) return;

      const gradients = [
        "linear-gradient(90deg,#ff2c7d,#36e3ff)",
        "linear-gradient(90deg,#36e3ff,#ffd33b)",
        "linear-gradient(90deg,#ffd33b,#ff2c7d)"
      ];

      genres.topGenres.forEach((g, idx) => {
        const chip = document.createElement("div");
        chip.className = "genre-chip";
        chip.style.backgroundImage = gradients[idx % gradients.length];
        const span = document.createElement("span");
        span.textContent = g.name;
        chip.appendChild(span);
        container.appendChild(chip);
        setTimeout(() => chip.classList.add("ready"), 90 * (idx + 1));
      });
    }

    async function fetchWrapped(username, period) {
      const url = `/api/wrapped?username=${encodeURIComponent(username)}&period=${encodeURIComponent(period)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("wrapped_failed");
      return res.json();
    }

    async function fetchGenres(username, period) {
      const url = `/api/wgenres?username=${encodeURIComponent(username)}&period=${encodeURIComponent(period)}`;
      const res = await fetch(url);
      if (!res.ok) return null;
      return res.json();
    }

    async function startStory() {
      inputError.textContent = "";
      const name = (usernameInput.value || "").trim();
      if (!name) {
        inputError.textContent = "username is required.";
        return;
      }

      currentUsername = name;

      showScreen("story");
      setActiveCard("card-loading");

      try {
        const [wrapped, genres] = await Promise.all([
          fetchWrapped(currentUsername, currentPeriod),
          fetchGenres(currentUsername, currentPeriod)
        ]);

        wrappedData = wrapped;
        genresData = genres;

        applyWrappedToCards(wrappedData);
        if (genresData) applyGenres(genresData);

        setTimeout(() => {
          setActiveCard("card-hello");
        }, 600);
      } catch (err) {
        console.error(err);
        inputError.textContent = "couldn't load wrapped for that user/period.";
        showScreen("input");
      }
    }

    startBtn.addEventListener("click", startStory);

    if (DEFAULT_USERNAME) {
      usernameInput.value = DEFAULT_USERNAME;
    }
  </script>
</body>
</html>
