<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>lastfm lab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
 <style>
  /* ---------- fonts ---------- */
  @import url("https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&family=Fraunces:wght@500;600&display=swap"); /* [web:448] */

  :root {
    --bg: #020010;
    --fg-main: #f9f5ff;
    --fg-soft: #c7b5ff;
    --fg-muted: #a5b4fc;
    --accent-1: #a855f7;
    --accent-2: #fb7185;
    --accent-3: #22d3ee;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html, body {
    height: 100%;
  }

  body {
    min-height: 100vh;
    background:
      radial-gradient(circle at top, #221638 0, var(--bg) 60%),
      radial-gradient(circle at 120% 120%, #020617 0, #000 60%);
    color: var(--fg-main);
    font-family: "DM Sans", system-ui, -apple-system, BlinkMacSystemFont,
      "SF Pro Text", "Inter", "Segoe UI", sans-serif;
    overflow: hidden;
    -webkit-tap-highlight-color: transparent;   /* remove blue tap overlay */
  }

  /* disable text selection/touch highlight for the stage */
  .scene {
    -webkit-user-select: none;
    user-select: none;
  }

  /* ---------- scenes & motion ---------- */

  .scene {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    text-align: center;
    opacity: 0;
    pointer-events: none;
    transform: translateY(16px) scale(0.985);
    transition:
      opacity 500ms ease-out,
      transform 500ms cubic-bezier(0.22, 0.61, 0.36, 1);
  }

  .scene.active {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0) scale(1);
  }

  /* ---------- blurred parallax blobs ---------- */

  .bg-blobs {
    position: fixed;
    inset: -25%;
    overflow: hidden;
    z-index: -1;
    filter: blur(8px);
  }

  .blob {
    position: absolute;
    width: 44vmax;
    height: 44vmax;
    border-radius: 999px;
    filter: blur(40px);
    opacity: 0.7;
    mix-blend-mode: screen;
    will-change: transform;
  }

  .blob1 {
    background: radial-gradient(circle at 30% 30%, var(--accent-1), transparent 60%);
    animation: float1 20s ease-in-out infinite alternate;
  }

  .blob2 {
    background: radial-gradient(circle at 60% 70%, var(--accent-2), transparent 60%);
    animation: float2 24s ease-in-out infinite alternate;
  }

  .blob3 {
    background: radial-gradient(circle at 80% 20%, var(--accent-3), transparent 60%);
    animation: float3 28s ease-in-out infinite alternate;
  }

  @keyframes float1 {
    0%   { transform: translate(-12%, -10%) scale(1); }
    100% { transform: translate(8%, 12%) scale(1.08); }
  }
  @keyframes float2 {
    0%   { transform: translate(22%, 4%) scale(1.02); }
    100% { transform: translate(-6%, 18%) scale(0.96); }
  }
  @keyframes float3 {
    0%   { transform: translate(6%, -14%) scale(1); opacity: 0.35; }
    100% { transform: translate(-18%, 4%) scale(1.12); opacity: 0.8; }
  }

  /* ---------- typography ---------- */

  .title-main {
    font-family: "Fraunces", "DM Sans", system-ui, serif;
    font-size: clamp(1.8rem, 4vw, 2.5rem);
    letter-spacing: 0.18em;
    text-transform: uppercase;
    margin-bottom: 8px;
    opacity: 0.95;
  }

  .sub {
    font-size: 0.9rem;
    color: var(--fg-soft);
    max-width: 420px;
    margin: 0 auto;
  }

  .scene-text-main {
    font-family: "Fraunces", system-ui, serif;
    font-size: clamp(1.3rem, 3vw, 1.8rem);
    max-width: 520px;
    margin: 0 auto 10px;
    line-height: 1.55;
    letter-spacing: 0.02em;
  }

  .scene-text-soft {
    font-size: 0.9rem;
    color: rgba(203, 213, 225, 0.9);
    max-width: 420px;
    margin: 0 auto;
  }

  .scene-hint {
    margin-top: 18px;
    font-size: 0.75rem;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    color: rgba(148, 163, 184, 0.6);
    animation: hintPulse 2.1s ease-in-out infinite;
  }

  @keyframes hintPulse {
    0%, 100% { opacity: 0.25; transform: translateY(0); }
    50%      { opacity: 0.8;  transform: translateY(-2px); }
  }

  /* ---------- inputs / chips / buttons (captcha + username) ---------- */

  .math-box, .input-row, .period-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-top: 18px;
    flex-wrap: wrap;
  }

  input {
    background: radial-gradient(circle at top, rgba(15,23,42,0.95), rgba(15,23,42,0.7));
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.5);
    color: var(--fg-main);
    padding: 7px 14px;
    outline: none;
    font-size: 0.9rem;
    min-width: 160px;
    transition: border-color 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
  }

  input::placeholder {
    color: rgba(148, 163, 184, 0.9);
  }

  input:focus {
    border-color: var(--accent-1);
    box-shadow: 0 0 0 1px rgba(168, 85, 247, 0.4);
    background: radial-gradient(circle at top, rgba(30,64,175,0.9), rgba(15,23,42,0.9));
  }

  .chip {
    border-radius: 999px;
    padding: 4px 11px;
    font-size: 0.8rem;
    border: 1px solid rgba(148, 163, 184, 0.55);
    cursor: pointer;
    background: rgba(15, 23, 42, 0.8);
    color: var(--fg-muted);
    transition: border-color 0.18s ease, background 0.18s ease, color 0.18s ease,
      transform 0.12s ease;
  }

  .chip:hover {
    transform: translateY(-1px);
    border-color: rgba(248, 250, 252, 0.7);
  }

  .chip.active {
    border-color: var(--accent-2);
    color: var(--fg-main);
    background: radial-gradient(circle at top, rgba(251, 113, 133, 0.4), rgba(15, 23, 42, 0.95));
  }

  .circle-btn {
    width: 34px;
    height: 34px;
    border-radius: 999px;
    border: 1px solid rgba(248, 250, 252, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    background: rgba(15, 23, 42, 0.9);
    transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease,
      border-color 0.18s ease;
  }

  .circle-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
    background: radial-gradient(circle at top, rgba(129, 140, 248, 0.4), rgba(15,23,42,0.96));
    border-color: rgba(248, 250, 252, 0.9);
  }

  .circle-btn span {
    font-size: 0.9rem;
  }

  .error {
    margin-top: 10px;
    font-size: 0.8rem;
    color: #fecaca;
  }

  /* ---------- hello animation ---------- */

  .hello-word {
    font-size: clamp(2.4rem, 6vw, 3.2rem);
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: lowercase;
    margin-bottom: 4px;
    opacity: 0;
    transform: translateY(18px);
    animation: helloIn 0.9s ease forwards;
  }

  .hello-name {
    font-size: clamp(1.6rem, 4vw, 2.1rem);
    font-family: "Fraunces", "Georgia", "Times New Roman", serif;
    letter-spacing: 0.06em;
    opacity: 0;
    transform: translateY(18px);
    animation: nameIn 0.9s ease forwards;
    animation-delay: 0.55s;
  }

  @keyframes helloIn {
    0% { opacity: 0; transform: translateY(18px) scale(0.96); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
  }

  @keyframes nameIn {
    0% { opacity: 0; transform: translateY(18px) scale(0.96); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
  }

  /* ---------- art circles ---------- */

  .art-circle {
    position: relative;
    width: 140px;
    height: 140px;
    border-radius: 999px;
    overflow: hidden;
    border: 1px solid rgba(248, 250, 252, 0.4);
    box-shadow: 0 18px 40px rgba(0,0,0,0.85);
    margin: 18px auto 10px;
    background: radial-gradient(circle at top, #4c1d95, #020617);
    transform: scale(0.92) translateY(6px);
    opacity: 0;
    animation: artIn 700ms ease-out forwards;
    animation-delay: 120ms;
  }

  .art-circle::before {
    content: "";
    position: absolute;
    inset: -18%;
    border-radius: inherit;
    background: conic-gradient(
      from 200deg,
      rgba(168,85,247,0.4),
      rgba(248,250,252,0.0),
      rgba(56,189,248,0.45),
      rgba(248,250,252,0.0),
      rgba(248,113,113,0.4)
    );
    mix-blend-mode: screen;
    filter: blur(14px);
    opacity: 0.8;
    animation: artHalo 22s linear infinite;
  }

  .art-circle img {
    position: relative;
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    border-radius: inherit;
    z-index: 1;
  }

  @keyframes artIn {
    0%   { opacity: 0; transform: scale(0.78) translateY(18px); }
    100% { opacity: 1; transform: scale(1) translateY(0); }
  }

  @keyframes artHalo {
    from { transform: rotate(0deg); }
    to   { transform: rotate(360deg); }
  }

  /* ---------- final list ---------- */

  .list-two-column {
    display: flex;
    flex-wrap: wrap;
    gap: 18px;
    width: min(780px, 92vw);
    margin-top: 18px;
  }

  .list-col {
    flex: 1 1 260px;
    text-align: left;
    font-size: 0.9rem;
  }

  .list-heading {
    font-size: 0.8rem;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: var(--fg-soft);
    margin-bottom: 8px;
  }

  .track-row, .artist-row {
    margin-bottom: 8px;
  }

  .track-name {
    font-weight: 500;
  }

  .track-artist {
    font-size: 0.8rem;
    color: var(--fg-soft);
  }

  /* ---------- genres / ribbons ---------- */

  .genre-ribbon {
    width: min(480px, 88vw);
    height: 16px;
    border-radius: 999px;
    margin: 10px auto 2px;
    position: relative;
    overflow: hidden;
    background: rgba(15,23,42,0.9);
    box-shadow: inset 0 0 0 1px rgba(148,163,184,0.35);
  }

  .genre-label {
    font-size: 0.8rem;
    color: var(--fg-main);
    opacity: 0.9;
    margin-top: 3px;
    text-transform: lowercase;
    letter-spacing: 0.04em;
  }

  .genre-fill {
    position: absolute;
    inset: 0;
    transform-origin: left;
    background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
    opacity: 0.95;
    transform: scaleX(0.08);
    transition: transform 0.8s cubic-bezier(0.22, 0.61, 0.36, 1);
  }

  .genre-ribbon.ready .genre-fill {
    transform: scaleX(var(--fill, 1));
  }

  .genre-ribbon:nth-of-type(4n+1) .genre-fill {
    background: linear-gradient(90deg, #a855f7, #22d3ee);
  }
  .genre-ribbon:nth-of-type(4n+2) .genre-fill {
    background: linear-gradient(90deg, #f97316, #ec4899);
  }
  .genre-ribbon:nth-of-type(4n+3) .genre-fill {
    background: linear-gradient(90deg, #22c55e, #14b8a6);
  }

  /* ---------- replay ---------- */

  .replay-btn {
    margin-top: 26px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 14px;
    border-radius: 999px;
    border: 1px solid rgba(248,250,252,0.7);
    background: rgba(0,0,0,0.65);
    cursor: pointer;
    font-size: 0.9rem;
    transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
  }

  .replay-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 10px 26px rgba(0,0,0,0.8);
    background: radial-gradient(circle at top, rgba(148,163,184,0.3), rgba(15,23,42,0.96));
  }

  .replay-icon {
    width: 18px;
    height: 18px;
    border-radius: 999px;
    border: 1px solid rgba(248,250,252,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
  }

  body { cursor: default; }
  .scene.active { cursor: pointer; }
  #scene-final { cursor: default; }

  .tiny-muted {
    font-size: 0.8rem;
    color: var(--fg-soft);
    margin-top: 6px;
  }
</style>
</head>
<body>
  <div class="bg-blobs">
    <div class="blob blob1"></div>
    <div class="blob blob2"></div>
    <div class="blob blob3"></div>
  </div>

  <!-- Scene 0: math gate -->
  <section class="scene active" id="scene-math">
    <div class="title-main">lastfm lab</div>
    <p class="sub">a tiny, overdramatic way to look at your last.fm listening.</p>

    <div class="math-box">
      <span id="math-question" style="font-size:0.95rem;"></span>
      <input id="math-answer" placeholder="answer" inputmode="numeric" />
      <button class="circle-btn" id="math-go" type="button">
        <span>→</span>
      </button>
    </div>
    <div class="error" id="math-error"></div>
  </section>

  <!-- Scene 1: username + period -->
  <section class="scene" id="scene-input">
    <div class="title-main">wrapped, but last.fm</div>
    <p class="sub">type a username and a little window of time; the rest is drama.</p>

    <div class="input-row">
      <input id="user-input" placeholder="last.fm username" />
    </div>

    <div class="period-row" id="period-row">
      <button class="chip active" data-period="7day">7d</button>
      <button class="chip" data-period="1month">1m</button>
      <button class="chip" data-period="3month">3m</button>
      <button class="chip" data-period="12month">1y</button>
      <button class="chip" data-period="overall">overall</button>
      <button class="circle-btn" id="wrapped-go" type="button">
        <span>→</span>
      </button>
    </div>
    <div class="error" id="input-error"></div>
  </section>

  <!-- Scene 1.5: hello username -->
  <section class="scene" id="scene-hello">
    <div class="hello-word">hello,</div>
    <div class="hello-name" id="hello-name"></div>
  </section>

  <!-- Scene 2: timeframe + total tracks/artist counts -->
  <section class="scene" id="scene-1">
    <div class="scene-text-main" id="scene1-main"></div>
    <div class="scene-text-soft" id="scene1-soft"></div>
  </section>

  <!-- Scene 3: top track -->
  <section class="scene" id="scene-2">
    <div class="scene-text-main">but you kept coming back to one track:</div>
    <div class="art-circle">
      <img id="toptrack-art" src="" alt="top track art" />
    </div>
    <div class="scene-text-main" id="toptrack-title"></div>
    <div class="scene-text-soft" id="toptrack-artist"></div>
  </section>

  <!-- Scene 4: artist count statement -->
  <section class="scene" id="scene-3">
    <div class="scene-text-main" id="scene3-main"></div>
  </section>

  <!-- Scene 5: top artist focus -->
  <section class="scene" id="scene-4">
    <div class="art-circle">
      <img id="topartist-art" src="" alt="top artist art" />
    </div>
    <div class="scene-text-main" id="topartist-name"></div>
    <div class="scene-text-soft" id="topartist-line"></div>
  </section>

  <!-- Scene 6: genres (optional) -->
  <section class="scene" id="scene-5">
    <div class="scene-text-main">the sounds around you most often were:</div>
    <div id="genre-wrap"></div>
    <div class="tiny-muted" id="genre-note"></div>
  </section>

  <!-- Scene 7: final summary + replay -->
  <section class="scene" id="scene-final">
    <div class="scene-text-main" id="final-title"></div>
    <div class="scene-text-soft" id="final-sub"></div>

    <div class="list-two-column">
      <div class="list-col">
        <div class="list-heading">top tracks</div>
        <div id="final-tracks"></div>
      </div>
      <div class="list-col">
        <div class="list-heading">top artists</div>
        <div id="final-artists"></div>
      </div>
    </div>

    <button class="replay-btn" id="replay-btn" type="button">
      <span class="replay-icon">↻</span>
      <span>again</span>
    </button>
  </section>

  <script>
    // ---------- global state + caching ----------
    let currentSceneIndex = 0;
    const sceneOrder = [
      "scene-math",
      "scene-input",
      "scene-hello",
      "scene-1",
      "scene-2",
      "scene-3",
      "scene-4",
      "scene-5",
      "scene-final"
    ];

    let chosenUser = "";
    let chosenPeriod = "3month";
    let wrappedData = null;
    let genresPromise = null;
    let genresResult = null;

    function showScene(id) {
      sceneOrder.forEach((sid) => {
        const el = document.getElementById(sid);
        if (!el) return;
        el.classList.toggle("active", sid === id);
      });
      currentSceneIndex = sceneOrder.indexOf(id);
    }

    // ---------- math captcha ----------
    const mathQ = document.getElementById("math-question");
    const mathA = document.getElementById("math-answer");
    const mathGo = document.getElementById("math-go");
    const mathErr = document.getElementById("math-error");

    let a = 0, b = 0, op = "+";

    function newMath() {
      a = Math.floor(Math.random() * 9) + 2;
      b = Math.floor(Math.random() * 9) + 1;
      op = Math.random() < 0.5 ? "+" : "-";
      mathQ.textContent = `${a} ${op} ${b} = ?`;
      mathA.value = "";
      mathErr.textContent = "";
    }

    function checkMath() {
      const val = Number((mathA.value || "").trim());
      const correct = op === "+" ? a + b : a - b;
      return val === correct;
    }

    mathGo.addEventListener("click", () => {
      if (!checkMath()) {
        mathErr.textContent = "almost. try again.";
        newMath();
        return;
      }
      showScene("scene-input");
    });

    // ---------- username + period ----------
    const userInput = document.getElementById("user-input");
    const periodRow = document.getElementById("period-row");
    const wrappedGo = document.getElementById("wrapped-go");
    const inputErr = document.getElementById("input-error");

    periodRow.addEventListener("click", (e) => {
      const btn = e.target.closest(".chip");
      if (!btn) return;
      periodRow
        .querySelectorAll(".chip")
        .forEach((c) => c.classList.remove("active"));
      btn.classList.add("active");
      chosenPeriod = btn.dataset.period || "3month";
    });

    async function startWrapped() {
      const u = (userInput.value || "").trim();
      if (!u) {
        inputErr.textContent = "username first.";
        return;
      }
      chosenUser = u;
      inputErr.textContent = "";

      const helloName = document.getElementById("hello-name");
      helloName.textContent = u;
      showScene("scene-hello");

      try {
        const url =
          `/api/wrapped?username=${encodeURIComponent(u)}&period=${encodeURIComponent(chosenPeriod)}`;
        const res = await fetch(url);
        if (!res.ok) {
          inputErr.textContent = "couldn’t reach last.fm right now.";
          showScene("scene-input");
          return;
        }
        wrappedData = await res.json();
        // cache in sessionStorage so replay doesn't refetch
        sessionStorage.setItem("lastfmWrapped", JSON.stringify({
          data: wrappedData,
          username: chosenUser,
          period: chosenPeriod
        }));
      } catch (e) {
        console.error("wrapped fetch failed", e);
        inputErr.textContent = "something went sideways with last.fm.";
        showScene("scene-input");
        return;
      }

      // kick off genres in the background now that we have topArtists
      const artistsPayload = (wrappedData.topArtists || []).map(a => ({
        name: a.name,
        playcount: a.playcount
      }));

      genresPromise = fetch("/api/wgenres", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ artists: artistsPayload })
      })
      .then(r => (r.ok ? r.json() : null))
      .then(json => {
        genresResult = json;
        return json;
      })
      .catch(err => {
        console.error("wgenres fetch failed", err);
        genresResult = null;
        return null;
      });

      // let hello animation breathe
      setTimeout(() => {
        if (!wrappedData) return;
        prepareScenesFromData(wrappedData);
        showScene("scene-1");
      }, 2200);
    }

    wrappedGo.addEventListener("click", startWrapped);

    // ---------- prepare scenes from wrappedData ----------
    function prepareScenesFromData(data) {
      const s1main = document.getElementById("scene1-main");
      const s1soft = document.getElementById("scene1-soft");
      const totalTracks = data.totalScrobbles || 0;
      const totalArtists = data.totalArtists || 0;
      s1main.textContent = `for the ${data.periodLabel || "recent while"}, you scrobbled ${totalTracks} tracks.`;
      s1soft.textContent = `you crossed paths with ${totalArtists} different artists.`;

      // Scene 2 top track
      const t = (data.topTracks || [])[0];
      const ttArt = document.getElementById("toptrack-art");
      const ttTitle = document.getElementById("toptrack-title");
      const ttArtist = document.getElementById("toptrack-artist");

      if (t) {
        ttArt.src = t.image || "";
        ttTitle.textContent = t.name || "";
        ttArtist.textContent = t.artist || "";
      } else {
        ttTitle.textContent = "no top track found here.";
        ttArtist.textContent = "";
      }

      // Scene 3 artist count
      const s3main = document.getElementById("scene3-main");
      s3main.textContent =
        totalArtists > 0
          ? `you drifted past ${totalArtists} artists, but one stayed a little louder than the rest.`
          : `not enough artists to pick a favourite from.`;

      // Scene 4 top artist
      const a = (data.topArtists || [])[0];
      const taArt = document.getElementById("topartist-art");
      const taName = document.getElementById("topartist-name");
      const taLine = document.getElementById("topartist-line");

      if (a) {
        taArt.src = a.image || "";
        taName.textContent = a.name || "";
        taLine.textContent = `you scrobbled them ${a.playcount || 0} times. that’s not casual.`;
      } else {
        taName.textContent = "no clear favourite artist.";
        taLine.textContent = "";
      }

      // Final scene
      const finalTitle = document.getElementById("final-title");
      const finalSub = document.getElementById("final-sub");
      finalTitle.textContent = `${data.username}`;
      finalSub.textContent = `wrapped for the ${data.periodLabel || "recent while"}.`;

      const finalTracks = document.getElementById("final-tracks");
      finalTracks.innerHTML = "";
      (data.topTracks || []).forEach((t) => {
        const row = document.createElement("div");
        row.className = "track-row";
        row.innerHTML =
          `<div class="track-name">${t.name}</div>` +
          `<div class="track-artist">${t.artist}</div>`;
        finalTracks.appendChild(row);
      });

      const finalArtists = document.getElementById("final-artists");
      finalArtists.innerHTML = "";
      (data.topArtists || []).forEach((a) => {
        const row = document.createElement("div");
        row.className = "artist-row";
        row.textContent = `${a.name} · ${a.playcount} plays`;
        finalArtists.appendChild(row);
      });

      // clear old genre ribbons if any
      const genreWrap = document.getElementById("genre-wrap");
      genreWrap.innerHTML = "";
      document.getElementById("genre-note").textContent = "";
    }

    // ---------- genre scene wiring ----------
    async function enterGenreScene() {
      showScene("scene-5");
      const genreWrap = document.getElementById("genre-wrap");
      const genreNote = document.getElementById("genre-note");

      genreWrap.innerHTML = "";
      genreNote.textContent = "";

      if (!genresPromise) {
        // nothing in flight → nothing to show, user can tap to skip
        return;
      }

      const result = genresResult || await genresPromise;
      if (!result || !Array.isArray(result.topGenres) || !result.topGenres.length) {
        genreNote.textContent = ""; // stay silent, just let tap skip
        return;
      }

      result.topGenres.forEach((g, idx) => {
        const ribbon = document.createElement("div");
        ribbon.className = "genre-ribbon";
        ribbon.style.setProperty("--fill", Math.max(0.2, g.weight || 0.1));
        const fill = document.createElement("div");
        fill.className = "genre-fill";
        ribbon.appendChild(fill);
        const label = document.createElement("div");
        label.className = "genre-label";
        label.textContent = g.name;
        genreWrap.appendChild(ribbon);
        genreWrap.appendChild(label);
        setTimeout(() => ribbon.classList.add("ready"), 80 * (idx + 1));
      });
    }

    // ---------- scene click progression ----------
    function nextScene() {
      const idx = currentSceneIndex;
      const nextIdx = idx + 1;
      if (nextIdx >= sceneOrder.length) return;
      const nextId = sceneOrder[nextIdx];
      showScene(nextId);
      if (nextId === "scene-5") {
        // entering genre scene
        enterGenreScene();
      }
    }

    ["scene-1","scene-2","scene-3","scene-4","scene-5"].forEach((id) => {
      const el = document.getElementById(id);
      el.addEventListener("click", () => nextScene());
    });

    const replayBtn = document.getElementById("replay-btn");
    replayBtn.addEventListener("click", () => {
      const cached = sessionStorage.getItem("lastfmWrapped");
      if (!cached) return;
      try {
        const parsed = JSON.parse(cached);
        wrappedData = parsed.data;
        chosenUser = parsed.username;
        chosenPeriod = parsed.period;
      } catch {
        return;
      }
      if (!wrappedData) return;
      const helloName = document.getElementById("hello-name");
      helloName.textContent = wrappedData.username;
      prepareScenesFromData(wrappedData);

      // restart genres in background based on cached data
      const artistsPayload = (wrappedData.topArtists || []).map(a => ({
        name: a.name,
        playcount: a.playcount
      }));
      genresResult = null;
      genresPromise = fetch("/api/wgenres", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ artists: artistsPayload })
      })
      .then(r => (r.ok ? r.json() : null))
      .then(json => {
        genresResult = json;
        return json;
      })
      .catch(err => {
        console.error("wgenres fetch failed (replay)", err);
        genresResult = null;
        return null;
      });

      showScene("scene-hello");
      setTimeout(() => {
        showScene("scene-1");
      }, 2200);
    });

    // init
    newMath();
  </script>
</body>
</html>
